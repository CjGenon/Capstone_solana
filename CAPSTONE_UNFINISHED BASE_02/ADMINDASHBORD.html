<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard â€“ Solano Hills</title>
  <link rel="stylesheet" href="dashboard.css" />
</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent('dashboard')">Dashboard</a></li>
        <li><a href="#" onclick="loadContent('Payment Received')">Payment Received</a></li>
        <li><a href="#" onclick="loadContent('Maintenance Requests')">Maintenance Requests</a></li>
        <li><a href="#" onclick="loadContent('Tenant Account Creation')">Tenant Account Creation</a></li>
        <li><a href="#" onclick="loadContent('Feedback Received')">Feedback Received</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <div id="mainContent">
      <h1>Welcome, <span id="admin-name">[Admin Name]</span></h1>
      <p>Select a menu option from the left to get started.</p>
    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.appspot.com",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('admin-name').textContent = user.email;
        console.log("Admin already logged in:", user.email);
      } else {
        window.location.href = "Login.html";
      }
    });

    function loadContent(section) {
      const area = document.getElementById('mainContent');
      document.querySelectorAll('.sidebar nav ul li a').forEach(link => link.classList.remove('active'));
      try { if (event && event.target) event.target.classList.add('active'); } catch(e){}

      switch (section) {
        case "dashboard":
          area.innerHTML = `
            <h1 id="Greeting1">Dashboard</h1>
            <div class="dashboard-container">
              <div class="welcome-slider">
                <div class="slide fade"><img src="1Entertainment room.jpg" alt="Welcome Slide 1" /></div>
                <div class="slide fade"><img src="1Fitness Gym.jpg" alt="Welcome Slide 2" /></div>
                <div class="slide fade"><img src="1Roof Garden.jpg" alt="Welcome Slide 3" /></div>
                <button class="prev" id="sliderPrev">&#10094;</button>
                <button class="next" id="sliderNext">&#10095;</button>
              </div>
              <div class="right-side">
                <div class="calendar-card">
                  <h3>ðŸ“… Calendar</h3>
                  <div id="calendar"></div>
                </div>
                <div class="inbox-card">
                  <h3>ðŸ“© Inbox Summary</h3>
                  <p>Check and reply to tenant feedback or messages.</p>
                  <button id="Feedback Received">Go to Inbox</button>
                </div>
              </div>
            </div>`;

          (function () {
            let slideIndexLocal = 1;
            const slides = () => document.querySelectorAll(".welcome-slider .slide");

            function showSlidesLocal(n) {
              const nodeList = slides();
              if (!nodeList || nodeList.length === 0) return;
              if (n > nodeList.length) slideIndexLocal = 1;
              if (n < 1) slideIndexLocal = nodeList.length;
              nodeList.forEach(s => (s.style.display = "none"));
              nodeList[slideIndexLocal - 1].style.display = "block";
            }

            showSlidesLocal(slideIndexLocal);

            document.getElementById("sliderPrev").addEventListener("click", () => showSlidesLocal(--slideIndexLocal));
            document.getElementById("sliderNext").addEventListener("click", () => showSlidesLocal(++slideIndexLocal));

            const sliderInterval = setInterval(() => showSlidesLocal(++slideIndexLocal), 5000);
            const sliderEl = document.querySelector(".welcome-slider");
            if (sliderEl) sliderEl.addEventListener("mouseenter", () => clearInterval(sliderInterval));
          })();

          (function () {
            function generateCalendar() {
              const calendar = document.getElementById("calendar");
              if (!calendar) return;

              const today = new Date();
              const monthName = today.toLocaleString("default", { month: "long" });
              const year = today.getFullYear();
              const firstDay = new Date(year, today.getMonth(), 1);
              const lastDay = new Date(year, today.getMonth() + 1, 0);
              const startDay = firstDay.getDay();

              let html = "<table class='cal-table'>";
              html += `<tr><th class='cal-header' colspan='7'>${monthName} ${year}</th></tr>`;
              html += "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

              for (let i = 0; i < startDay; i++) html += "<td class='cal-empty'></td>";

              for (let day = 1; day <= lastDay.getDate(); day++) {
                const isToday = day === today.getDate();
                html += `<td${isToday ? " class='today'" : ""}>${day}</td>`;
                if ((day + startDay) % 7 === 0 && day !== lastDay.getDate()) html += "</tr><tr>";
              }
              html += "</tr></table>";
              calendar.innerHTML = html;
            }
            generateCalendar();
          })();
          break;

        case 'Payment Received':
          area.innerHTML = '<h1>Payments Received</h1><p>View Payments of Tenants</p>';
          break;

        case 'Maintenance Requests':
          area.innerHTML = `
            <h1>Maintenance Requests</h1>
            <p>Maintenance requests submitted by tenants will appear here.</p>
            <div id="maintenanceList" style="margin-top:20px;">
              <p>Loading maintenance requests...</p>
            </div>`;

          async function loadMaintenanceRequests() {
            const maintenanceList = document.getElementById('maintenanceList');

            db.collection("maintenanceRequests")
              .orderBy("timestamp", "desc")
              .onSnapshot(snapshot => {
                if (snapshot.empty) {
                  maintenanceList.innerHTML = "<p>No maintenance requests found.</p>";
                  return;
                }
                maintenanceList.innerHTML = "";
                snapshot.forEach(docSnap => {
                  const data = docSnap.data();
                  const id = docSnap.id;

                  const card = document.createElement("div");
                  card.className = "maintenance-card";
                  card.style.border = "1px solid #ccc";
                  card.style.padding = "10px";
                  card.style.marginBottom = "10px";

                  const statusOptions = ["Pending", "Complete"];
                  const statusSelect = document.createElement("select");
                  statusOptions.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option;
                    opt.textContent = option;
                    if (data.status === option) opt.selected = true;
                    statusSelect.appendChild(opt);
                  });
                  statusSelect.style.marginRight = "10px";

                  const personnelInput = document.createElement("input");
                  personnelInput.type = "text";
                  personnelInput.placeholder = "Assign maintenance personnel";
                  personnelInput.value = data.maintenanceName || "";
                  personnelInput.style.marginRight = "10px";

                  const updateBtn = document.createElement("button");
                  updateBtn.textContent = "Update";
                  updateBtn.style.background = "#8d6c39";
                  updateBtn.style.color = "white";
                  updateBtn.style.border = "none";
                  updateBtn.style.borderRadius = "6px";
                  updateBtn.style.padding = "6px 12px";
                  updateBtn.style.cursor = "pointer";
                  updateBtn.style.marginRight = "10px";

                  if (data.status === "Complete") {
                    statusSelect.disabled = true;
                    personnelInput.disabled = true;
                    updateBtn.disabled = true;
                    statusSelect.style.backgroundColor = "#e0e0e0";
                    personnelInput.style.backgroundColor = "#e0e0e0";
                    updateBtn.style.backgroundColor = "#aaa";
                    updateBtn.style.cursor = "not-allowed";
                  }

                  updateBtn.addEventListener("click", async () => {
                    try {
                      await db.collection("maintenanceRequests").doc(id).update({
                        status: statusSelect.value,
                        maintenanceName: personnelInput.value.trim(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                      });
                      alert("Request updated successfully!");
                    } catch (error) {
                      alert("Error updating request: " + error.message);
                    }
                  });

                  const respondBtn = document.createElement("button");
                  respondBtn.textContent = "Respond";
                  respondBtn.style.background = "#4a90e2";
                  respondBtn.style.color = "white";
                  respondBtn.style.border = "none";
                  respondBtn.style.borderRadius = "6px";
                  respondBtn.style.padding = "6px 12px";
                  respondBtn.style.cursor = "pointer";

                  respondBtn.addEventListener("click", async () => {
                    const responseMessage = prompt("Enter your response message to the tenant:");
                    if (responseMessage && responseMessage.trim() !== "") {
                      try {
                        const requestDocRef = db.collection("maintenanceRequests").doc(id);
                        await requestDocRef.collection("responses").add({
                          adminEmail: auth.currentUser.email,
                          message: responseMessage.trim(),
                          timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        await requestDocRef.update({
                          responseTime: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert("Response sent successfully!");
                      } catch (error) {
                        alert("Failed to send response: " + error.message);
                      }
                    }
                  });

                  let attachmentHTML = "";
                  if (data.imageUrl) {
                    attachmentHTML = `<div style="margin-top:10px;">
                      <strong>Attachment:</strong><br/>
                      <img src="${data.imageUrl}" alt="Attachment" style="max-width:100%; border-radius:8px;" />
                    </div>`;
                  }

                  card.innerHTML = `
                    <h3>${data.problem || 'Unknown Issue'}</h3>
                    <p><strong>Tenant:</strong> ${data.tenantEmail || 'Unknown Tenant'}</p>
                    <p><strong>Details:</strong> ${data.comment || 'No additional details.'}</p>
                    <p><strong>Submitted:</strong> ${data.timestamp?.toDate ? data.timestamp.toDate().toLocaleString() : 'Unknown time'}</p>
                  ` + attachmentHTML;

                  card.appendChild(statusSelect);
                  card.appendChild(personnelInput);
                  card.appendChild(updateBtn);
                  card.appendChild(respondBtn);
                  maintenanceList.appendChild(card);
                });
              }, error => {
                maintenanceList.innerHTML = `<p style="color:red;">Error loading requests: ${error.message}</p>`;
              });
          }
          loadMaintenanceRequests();
          break;

        case 'Tenant Account Creation':
          area.innerHTML = `
            <h1>Create New Tenant Account</h1>
            <form id="createTenantForm">
              <input type="email" id="tenantEmail" placeholder="Tenant Email" required style="padding:10px;margin-bottom:10px;width:100%;" />
              <input type="password" id="tenantPassword" placeholder="Temporary Password" required style="padding:10px;margin-bottom:10px;width:100%;" />
              <button type="submit" style="padding:10px 20px;background:#8d6c39;color:white;border:none;border-radius:6px;">Create Tenant</button>
            </form>
            <p id="statusMessage" style="margin-top:10px;"></p>`;

          setTimeout(() => {
            const form = document.getElementById('createTenantForm');
            const statusMessage = document.getElementById('statusMessage');

            form.addEventListener('submit', async function (e) {
              e.preventDefault();
              const email = document.getElementById('tenantEmail').value;
              const password = document.getElementById('tenantPassword').value;

              try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                await db.collection("users").doc(user.uid).set({
                  email: email,
                  role: "tenant",
                  mustChangePassword: true,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                statusMessage.style.color = 'lightgreen';
                statusMessage.textContent = "Tenant created successfully!";
                form.reset();
              } catch (error) {
                statusMessage.style.color = 'red';
                statusMessage.textContent = "Error: " + error.message;
              }
            });
          }, 100);
          break;

        case 'Feedback Received':
          area.innerHTML = `
            <h1>Feedback from Tenants</h1>
            <div class="feedback-controls">
              <label><input type="checkbox" id="selectAllCheckbox" /> Select All</label>
              <button id="deleteSelectedBtn" class="btn btn-danger" disabled>Delete Selected</button>
              <button id="refreshFeedbackBtn" class="btn btn-ghost">Refresh</button>
              <span id="feedbackStatus" style="margin-left:8px;color:#666;"></span>
            </div>
            <div id="feedback-list">Loading...</div>`;

          document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedFeedbacks);
          document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
          document.getElementById('refreshFeedbackBtn').addEventListener('click', loadFeedbacks);
          loadFeedbacks();
          break;

        default:
          area.innerHTML = '<h1>Welcome</h1><p>Select a menu option from the sidebar.</p>';
      }
    }

    async function loadFeedbacks() {
      const feedbackList = document.getElementById('feedback-list');
      const statusSpan = document.getElementById('feedbackStatus');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const selectAll = document.getElementById('selectAllCheckbox');

      feedbackList.innerHTML = '<p>Loading feedback...</p>';
      statusSpan.textContent = '';

      try {
        const snapshot = await db.collection("feedback").orderBy("timestamp", "desc").get();

        if (snapshot.empty) {
          feedbackList.innerHTML = '<p>No feedback found.</p>';
          deleteBtn.disabled = true;
          selectAll.checked = false;
          return;
        }

        feedbackList.innerHTML = '';

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;

          const wrapper = document.createElement('div');
          wrapper.className = 'feedback-item';
          wrapper.style.border = '1px solid #ccc';
          wrapper.style.padding = '10px';
          wrapper.style.marginBottom = '10px';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'feedback-checkbox';
          checkbox.dataset.id = id;
          checkbox.id = `chk-${id}`;
          checkbox.classList.add('feedback-item-checkbox');

          checkbox.addEventListener('change', () => {
            const anyChecked = !!document.querySelector('.feedback-checkbox:checked');
            deleteBtn.disabled = !anyChecked;

            const total = document.querySelectorAll('.feedback-checkbox').length;
            const checked = document.querySelectorAll('.feedback-checkbox:checked').length;
            selectAll.checked = (total === checked && total > 0);
            selectAll.indeterminate = (checked > 0 && checked < total);
          });

          const content = document.createElement('div');
          content.className = 'feedback-item-content';

          const timeText = data.timestamp?.toDate ? data.timestamp.toDate().toLocaleString() :
            (data.timestamp && data.timestamp.seconds ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'Unknown time');

          content.innerHTML = `
            <strong>From:</strong> ${data.tenantEmail || "Unknown"}<br/>
            <strong>Message:</strong> ${escapeHtml(data.message || "No message")}<br/>
            <small style="color:#666">${timeText}</small>`;

          const perDeleteBtn = document.createElement('button');
          perDeleteBtn.textContent = 'Delete';
          perDeleteBtn.className = 'btn btn-danger';
          perDeleteBtn.style.marginLeft = '8px';
          perDeleteBtn.addEventListener('click', async () => {
            if (!confirm('Delete this feedback? This action cannot be undone.')) return;
            try {
              await db.collection('feedback').doc(id).delete();
              statusSpan.textContent = 'Feedback deleted.';
              loadFeedbacks();
            } catch (error) {
              alert('Delete failed: ' + error.message);
            }
          });

          wrapper.appendChild(checkbox);
          wrapper.appendChild(content);
          wrapper.appendChild(perDeleteBtn);
          feedbackList.appendChild(wrapper);
        });

        deleteBtn.disabled = true;
        selectAll.checked = false;
        selectAll.indeterminate = false;

      } catch (error) {
        feedbackList.innerHTML = `<p style="color:red;">Error loading feedback: ${error.message}</p>`;
      }
    }

    function toggleSelectAll(e) {
      const checked = e.target.checked;
      document.querySelectorAll('.feedback-checkbox').forEach(cb => cb.checked = checked);
      document.getElementById('deleteSelectedBtn').disabled = !checked;
    }

    async function deleteSelectedFeedbacks() {
      const selected = [...document.querySelectorAll('.feedback-checkbox:checked')].map(cb => cb.dataset.id);
      if (selected.length === 0) return alert("No feedback selected.");

      if (!confirm(`Delete ${selected.length} selected feedback(s)? This action cannot be undone.`)) return;

      try {
        const batch = db.batch();
        selected.forEach(id => {
          const ref = db.collection('feedback').doc(id);
          batch.delete(ref);
        });
        await batch.commit();
        document.getElementById('feedbackStatus').textContent = `Deleted ${selected.length} feedback(s).`;
        loadFeedbacks();
      } catch (error) {
        alert("Delete failed: " + error.message);
      }
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
