<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tenant Dashboard â€“ Solano Hills</title>
  <link rel="stylesheet" href="Dashboard.css" />
</head>
<body>

  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')">Dashboard</a></li>
        <!-- alisin muna -->
        <!-- <li><a href="#" onclick="loadContent(event, 'profile')">My Profile</a></li> -->
        <li><a href="#" onclick="loadContent(event, 'maintenance')">Maintenance</a></li>
        <li><a href="#" onclick="loadContent(event, 'billing')">Billing and Payments</a></li>
        <li><a href="#" onclick="loadContent(event, 'feedback')">Feedback</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <h1 id="tenantGreeting">Welcome back, Tenant</h1>
      <p>Select a menu option from the left to get started.</p>
    </div>
  </main>

  <!-- ======================== FIREBASE SCRIPTS ======================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.firebasestorage.app",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    function getCurrentUserEmail() {
      return new Promise(resolve => {
        const unsubscribe = onAuthStateChanged(auth, user => {
          unsubscribe();
          resolve(user ? user.email : "Unknown Tenant");
        });
      });
    }

    const mainContent = document.getElementById('mainContent');

    window.loadContent = function(event, section) {
      event.preventDefault();
      document.querySelectorAll('.sidebar nav ul li a').forEach(link => link.classList.remove('active'));
      event.target.classList.add('active');

      switch(section) {
        case 'dashboard':
          mainContent.innerHTML = `<h1 id="tenantGreeting1">Hi,</h1><p>Here is the Overview of your account and recent activity.</p>`;
          updateGreeting();
          break;

        case 'profile':
          mainContent.innerHTML = '<h1>My Profile</h1><p>View and edit your personal information.</p>';
          break;

        case 'maintenance':
          mainContent.innerHTML = `
            <div class="maintenance-tab" style="display:flex; gap:20px;">
              <!-- Form Section -->
              <div style="flex:2;">
                <h2>Maintenance Request</h2>
                <p><strong>What issue do you want to report?</strong></p>

                <label for="problem">Select issue type:</label>
                <select id="problem" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                  <option value="">-- Select --</option>
                  <option value="plumbing">Plumbing</option>
                  <option value="electrical">Electrical</option>
                  <option value="aircon">Air Conditioning</option>
                  <option value="other">Others</option>
                </select>

                <div id="otherSection" style="display:none; margin-top:15px;">
                  <label for="otherComment">Describe the problem:</label>
                  <textarea id="otherComment" rows="4" placeholder="Write details here..." style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"></textarea>

                  <label for="imageUpload" style="margin-top:10px; display:block;">Upload at least 2 JPEG images:</label>
                  <input type="file" id="imageUpload" accept="image/jpeg" multiple style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                </div>

                <button id="submitReport" style="margin-top:15px; padding:10px 20px; background:#8d6c39; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px;">Submit</button>

                <p id="statusMessage" style="margin-top:10px; color:green;"></p>
              </div>

              <!-- History / Status Section -->
              <div style="flex:1; border-left:1px solid #ccc; padding-left:15px;">
                <h3>Request History</h3>
                <div id="historyList" style="max-height:400px; overflow-y:auto; font-size:14px; color:white;">
                  <p>Loading your requests...</p>
                </div>
              </div>
            </div>
          `;

          const problemSelect = document.getElementById('problem');
          const otherSection = document.getElementById('otherSection');
          const submitButton = document.getElementById('submitReport');
          const statusMessage = document.getElementById('statusMessage');
          const imageUpload = document.getElementById('imageUpload');
          const otherComment = document.getElementById('otherComment');
          const historyList = document.getElementById('historyList');

          problemSelect.addEventListener('change', () => {
            otherSection.style.display = (problemSelect.value === 'other') ? 'block' : 'none';
          });

          async function loadHistory() {
            historyList.innerHTML = '<p>Loading your requests...</p>';
            try {
              const tenantEmail = await getCurrentUserEmail();
              const q = collection(db, "maintenanceRequests");
              const querySnapshot = await getDocs(query(q, where("tenantEmail", "==", tenantEmail), orderBy("timestamp", "desc"), limit(10)));

              if (querySnapshot.empty) {
                historyList.innerHTML = '<p>No maintenance requests found.</p>';
                return;
              }

              historyList.innerHTML = '';

              for (const doc of querySnapshot.docs) {
                const data = doc.data();
                const docId = doc.id;
                const timeStamp = data.timestamp ? data.timestamp.toDate().toLocaleString() : "N/A";
                const status = data.status || "Pending";
                const responseTime = data.responseTime ? (data.responseTime.toDate ? data.responseTime.toDate().toLocaleString() : data.responseTime) : "Not yet responded";
                const maintenanceName = data.maintenanceName || "Not assigned";

                const item = document.createElement('div');
                item.style.borderBottom = "1px solid #ddd";
                item.style.padding = "10px 0";

                const responsesContainer = document.createElement('div');
                responsesContainer.style.marginTop = '8px';
                responsesContainer.style.paddingLeft = '10px';
                responsesContainer.style.borderLeft = '3px solid #8d6c39';
                responsesContainer.innerHTML = '<em>Loading admin responses...</em>';

                item.innerHTML = `
                  <strong>Issue:</strong> ${data.problem}<br/>
                  <strong>Status:</strong> ${status}<br/>
                  <strong>Maintenance Personnel:</strong> ${maintenanceName}<br/>
                  <strong>Response Time:</strong> ${responseTime}<br/>
                  <strong>Submitted:</strong> ${timeStamp}<br/>
                  <strong>Admin Responses:</strong>
                `;

                item.appendChild(responsesContainer);
                historyList.appendChild(item);

                const responsesQuery = query(
                  collection(db, "maintenanceRequests", docId, "responses"),
                  orderBy("timestamp", "desc")
                );

                const responsesSnapshot = await getDocs(responsesQuery);

                if (responsesSnapshot.empty) {
                  responsesContainer.innerHTML = '<em>No admin responses yet.</em>';
                } else {
                  responsesContainer.innerHTML = '';
                  responsesSnapshot.forEach(respDoc => {
                    const respData = respDoc.data();
                    const time = respData.timestamp ? respData.timestamp.toDate().toLocaleString() : "No timestamp";
                    const respDiv = document.createElement('div');
                    respDiv.style.marginBottom = '6px';
                    respDiv.innerHTML = `
                      <strong>${respData.adminEmail}</strong> (${time}):<br/>
                      <span>${respData.message}</span>
                    `;
                    responsesContainer.appendChild(respDiv);
                  });
                }
              }
            } catch (error) {
              historyList.innerHTML = `<p style="color:red;">Failed to load history: ${error.message}</p>`;
            }
          }

          loadHistory();

          submitButton.addEventListener('click', async () => {
            const problem = problemSelect.value;
            const comment = otherComment.value.trim();

            if (!problem) {
              alert('Please select an issue type.');
              return;
            }

            if (problem === 'other') {
              if (!comment) {
                alert('Please describe the problem in "Others".');
                return;
              }
              if (!imageUpload.files || imageUpload.files.length < 2) {
                alert('Please upload at least 2 JPEG images.');
                return;
              }

              for (const file of imageUpload.files) {
                if (file.type !== "image/jpeg") {
                  alert('Only JPEG images are allowed.');
                  return;
                }
              }
            }

            statusMessage.style.color = "gray";
            statusMessage.textContent = "Submitting your request...";

            try {
              const tenantEmail = await getCurrentUserEmail();

              let imageUrls = [];
              if (problem === 'other' && imageUpload.files.length > 0) {
                const storage = getStorage(app);
                for (const file of imageUpload.files) {
                  const storageRef = ref(storage, `maintenanceImages/${tenantEmail}/${Date.now()}_${file.name}`);
                  await uploadBytes(storageRef, file);
                  const url = await getDownloadURL(storageRef);
                  imageUrls.push(url);
                }
              }

              await addDoc(collection(db, "maintenanceRequests"), {
                tenantEmail,
                problem,
                comment: problem === 'other' ? comment : '',
                imageUrls: imageUrls,
                status: "Pending",
                responseTime: "Not yet responded",
                timestamp: serverTimestamp()
              });

              statusMessage.style.color = "green";
              statusMessage.textContent = "Maintenance request submitted successfully!";

              problemSelect.value = "";
              otherComment.value = "";
              imageUpload.value = "";
              otherSection.style.display = "none";

              loadHistory();

            } catch (error) {
              console.error("Error submitting request: ", error);
              statusMessage.style.color = "red";
              statusMessage.textContent = "Failed to submit request: " + error.message;
            }
          });
          break;

        case 'billing':
          mainContent.innerHTML = '<h1>Billing and Payments</h1><p>View and pay your bills securely.</p>';
          break;

        case 'feedback':
          loadFeedbackForm();
          break;

        default:
          mainContent.innerHTML = '<p>Section not found.</p>';
      }
    }

    function loadFeedbackForm() {
      mainContent.innerHTML = `
        <div class="feedback-container">
          <h2>Send Feedback to Admin</h2>
          <form id="feedbackForm">
            <textarea id="feedbackText" placeholder="Write your feedback..." required style="width:100%;height:120px;padding:10px;border-radius:8px;"></textarea>
            <br/>
            <button id="sendFeedbackBtn" type="submit" style="padding:10px 20px;background:#8d6c39;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;">Send Feedback</button>
          </form>
          <p id="statusMessage" style="margin-top:10px;color:green;"></p>
        </div>
      `;

      const form = document.getElementById("feedbackForm");
      const feedbackText = document.getElementById("feedbackText");
      const statusMessage = document.getElementById("statusMessage");
      const sendBtn = document.getElementById("sendFeedbackBtn");

      function disableButtonForCooldown() {
        sendBtn.disabled = true;
        sendBtn.style.background = "gray";
        sendBtn.style.cursor = "not-allowed";
      }

      function enableButton() {
        sendBtn.disabled = false;
        sendBtn.style.background = "#8d6c39";
        sendBtn.style.cursor = "pointer";
      }

      const cooldownEnd = localStorage.getItem("feedbackCooldownEnd");
      if (cooldownEnd && Date.now() < cooldownEnd) {
        disableButtonForCooldown();
        const remaining = Math.round((cooldownEnd - Date.now()) / 1000);
        statusMessage.textContent = `You can send feedback again in ${remaining}s`;

        const countdown = setInterval(() => {
          const timeLeft = Math.round((cooldownEnd - Date.now()) / 1000);
          if (timeLeft <= 0) {
            clearInterval(countdown);
            enableButton();
            statusMessage.textContent = "";
            localStorage.removeItem("feedbackCooldownEnd");
          } else {
            statusMessage.textContent = `You can send feedback again in ${timeLeft}s`;
          }
        }, 1000);
      }

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          statusMessage.textContent = "Please log in to send feedback.";
          form.style.display = "none";
        } else {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            disableButtonForCooldown();
            statusMessage.style.color = "gray";
            statusMessage.textContent = "Sending feedback...";

            try {
              await addDoc(collection(db, "feedback"), {
                tenantEmail: user.email,
                message: feedbackText.value,
                timestamp: serverTimestamp()
              });

              statusMessage.style.color = "green";
              statusMessage.textContent = "Feedback sent successfully!";
              feedbackText.value = "";

              const cooldownTime = Date.now() + 60000;
              localStorage.setItem("feedbackCooldownEnd", cooldownTime);

              let countdown = setInterval(() => {
                const timeLeft = Math.round((cooldownTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                  clearInterval(countdown);
                  enableButton();
                  statusMessage.textContent = "";
                  localStorage.removeItem("feedbackCooldownEnd");
                } else {
                  statusMessage.textContent = `You can send feedback again in ${timeLeft}s`;
                }
              }, 1000);

            } catch (error) {
              console.error("Error sending feedback: ", error);
              statusMessage.style.color = "red";
              statusMessage.textContent = "Error sending feedback.";
              enableButton();
            }
          });
        }
      });
    }

    function updateGreeting() {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const greeting = document.getElementById('tenantGreeting1');
          const nameToShow = user.displayName || user.email;
          if (greeting) {
            greeting.textContent = `Hi, ${nameToShow}`;
          }
        }
      });
    }

    function showWelcomeBack() {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const greeting = document.getElementById('tenantGreeting');
          const nameToShow = user.displayName || user.email;
          if (greeting) {
            greeting.textContent = `Welcome back, ${nameToShow}`;
          }
        }
      });
    }

    showWelcomeBack();
  </script>
</body>
</html>
