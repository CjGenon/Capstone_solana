<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tenant Dashboard – Solano Hills</title>
  <link rel="stylesheet" href="Dashboard.css" />
</head>
<body>

  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')">Dashboard</a></li>
        <!-- alisin muna -->
        <!-- <li><a href="#" onclick="loadContent(event, 'profile')">My Profile</a></li> -->
        <li><a href="#" onclick="loadContent(event, 'maintenance')">Maintenance</a></li>
        <li><a href="#" onclick="loadContent(event, 'billing')">Billing and Payments</a></li>
        <li><a href="#" onclick="loadContent(event, 'feedback')">Feedback</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <h1 id="tenantGreeting">Welcome back, Tenant</h1>
      <p>Select a menu option from the left to get started.</p>
    </div>
  </main>

  <!-- ======================== FIREBASE SCRIPTS ======================== -->
   <script src="https://www.paypal.com/sdk/js?client-id=ASbUIe1_A3shQqfiUe1_TnYnp7jGyD-_pClj10rYjAG7Fmbu_sPi6s8LoJD2bRv6bT2XkJBo-FpPO5t4&currency=PHP"></script>
   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.firebasestorage.app",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    function getCurrentUserEmail() {
      return new Promise(resolve => {
        const unsubscribe = onAuthStateChanged(auth, user => {
          unsubscribe();
          resolve(user ? user.email : "Unknown Tenant");
        });
      });
    }

    const mainContent = document.getElementById('mainContent');

    window.loadContent = function(event, section) {
      event.preventDefault();
      document.querySelectorAll('.sidebar nav ul li a').forEach(link => link.classList.remove('active'));
      event.target.classList.add('active');

      switch(section) {
        case 'dashboard':
          mainContent.innerHTML = `<h1 id="tenantGreeting1">Hi,</h1><p>Here is the Overview of your account and recent activity.</p>`;
          updateGreeting();
          break;

        case 'profile':
          mainContent.innerHTML = '<h1>My Profile</h1><p>View and edit your personal information.</p>';
          break;

        case 'maintenance':
          mainContent.innerHTML = `
            <div class="maintenance-tab" style="display:flex; gap:20px; flex-wrap: wrap;">
              <!-- Form Section -->
              <div style="flex:2; min-width:300px;">
                <h2>Maintenance Request</h2>
                <p><strong>What issue do you want to report?</strong></p>

                <label for="problem">Select issue type:</label>
                <select id="problem" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                  <option value="">-- Select --</option>
                  <option value="plumbing">Plumbing</option>
                  <option value="electrical">Electrical</option>
                  <option value="aircon">Air Conditioning</option>
                  <option value="unit">Unit Maintenance</option>
                  <option value="other">Others</option>
                </select>

                <div id="otherSection" style="display:none; margin-top:15px;">
                  <label for="otherComment">Describe the problem:</label>
                  <textarea id="otherComment" rows="4" placeholder="Write details here..." style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"></textarea>

                  <label for="imageUpload" style="margin-top:10px; display:block;">Upload at least 2 JPEG images:</label>
                  <input type="file" id="imageUpload" accept="image/jpeg" multiple style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
                </div>

                <label for="preferredDate" style="margin-top:15px; display:block;">Select preferred maintenance visit date and time:</label>
                <input type="datetime-local" id="preferredDate" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;" min="" />

                <button id="submitReport" style="margin-top:15px; padding:10px 20px; background:#8d6c39; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px;">Submit</button>

                <p id="statusMessage" style="margin-top:10px; color:green;"></p>

                <div style="margin-top:20px; font-size:14px; padding:10px; border-radius:6px; color:#fff;">
                  <strong>Tenant Responsibilities:</strong>
                  <ul>
                    <li>Be available during the scheduled visit.</li>
                    <li>Provide access to the unit.</li>
                    <li>Report any urgent issues immediately.</li>
                  </ul>

                  <strong>Expected Response Times:</strong>
                  <ul>
                    <li>Non-urgent issues: within 3 business days.</li>
                    <li>Urgent issues (e.g. plumbing leaks): within 24 hours.</li>
                  </ul>
                </div>
              </div>

              <!-- History / Status Section -->
              <div style="flex:1; min-width:300px; border-left:1px solid #ccc; padding-left:15px; max-height:600px; overflow-y:auto; font-size:14px; color:#ffff; border-radius:6px;">
                <h3>Request History</h3>
                <div id="historyList" style="max-height:520px; overflow-y:auto;">
                  <p>Loading your requests...</p>
                </div>
              </div>
            </div>
          `;

          // Helper function to format date with AM/PM
          function formatDateTimeAMPM(date) {
            if (!(date instanceof Date)) {
              if (date && date.toDate) {
                date = date.toDate();
              } else {
                return "Invalid date";
              }
            }
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year} ${hours}:${minutes} ${ampm}`;
          }

          // Set minimum datetime-local to current date/time (rounded up to next 15 min)
          const preferredDateInput = document.getElementById('preferredDate');
          const now = new Date();
          now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15);
          preferredDateInput.min = now.toISOString().slice(0, 16);

          // Existing variables
          const problemSelect = document.getElementById('problem');
          const otherSection = document.getElementById('otherSection');
          const submitButton = document.getElementById('submitReport');
          const statusMessage = document.getElementById('statusMessage');
          const imageUpload = document.getElementById('imageUpload');
          const otherComment = document.getElementById('otherComment');
          const historyList = document.getElementById('historyList');

          problemSelect.addEventListener('change', () => {
            otherSection.style.display = (problemSelect.value === 'other') ? 'block' : 'none';
          });

          async function loadHistory() {
            historyList.innerHTML = '<p>Loading your requests...</p>';
            try {
              const tenantEmail = await getCurrentUserEmail();
              const q = collection(db, "maintenanceRequests");
              const querySnapshot = await getDocs(query(q, where("tenantEmail", "==", tenantEmail), orderBy("timestamp", "desc"), limit(10)));

              if (querySnapshot.empty) {
                historyList.innerHTML = '<p>No maintenance requests found.</p>';
                return;
              }

              historyList.innerHTML = '';

              for (const doc of querySnapshot.docs) {
                const data = doc.data();
                const docId = doc.id;
                const timeStamp = data.timestamp ? formatDateTimeAMPM(data.timestamp) : "N/A";
                const status = data.status || "Pending";
                const responseTime = data.responseTime ? formatDateTimeAMPM(data.responseTime) : "Not yet responded";
                const maintenanceName = data.maintenanceName || "Not assigned";
                const scheduledVisit = data.preferredVisitTime ? formatDateTimeAMPM(data.preferredVisitTime) : "Not scheduled";

                const item = document.createElement('div');
                item.style.borderBottom = "1px solid #ddd";
                item.style.padding = "10px 0";

                const responsesContainer = document.createElement('div');
                responsesContainer.style.marginTop = '8px';
                responsesContainer.style.paddingLeft = '10px';
                responsesContainer.style.borderLeft = '3px solid #8d6c39';
                responsesContainer.innerHTML = '<em>Loading admin responses...</em>';

                item.innerHTML = `
                  <strong>Issue:</strong> ${data.problem}<br/>
                  <strong>Description:</strong> ${data.comment || "-"}<br/>
                  <strong>Scheduled Visit:</strong> ${scheduledVisit}<br/>
                  <strong>Status:</strong> ${status}<br/>
                  <strong>Maintenance Personnel:</strong> ${maintenanceName}<br/>
                  <strong>Response Time:</strong> ${responseTime}<br/>
                  <strong>Submitted:</strong> ${timeStamp}<br/>
                  <strong>Admin Responses:</strong>
                `;

                item.appendChild(responsesContainer);
                historyList.appendChild(item);

                const responsesQuery = query(
                  collection(db, "maintenanceRequests", docId, "responses"),
                  orderBy("timestamp", "desc")
                );

                const responsesSnapshot = await getDocs(responsesQuery);

                if (responsesSnapshot.empty) {
                  responsesContainer.innerHTML = '<em>No admin responses yet.</em>';
                } else {
                  responsesContainer.innerHTML = '';
                  responsesSnapshot.forEach(respDoc => {
                    const respData = respDoc.data();
                    const time = respData.timestamp ? formatDateTimeAMPM(respData.timestamp) : "No timestamp";
                    const respDiv = document.createElement('div');
                    respDiv.style.marginBottom = '6px';
                    respDiv.innerHTML = `
                      <strong>${respData.adminEmail}</strong> (${time}):<br/>
                      <span>${respData.message}</span>
                    `;
                    responsesContainer.appendChild(respDiv);
                  });
                }
              }
            } catch (error) {
              historyList.innerHTML = `<p style="color:red;">Failed to load history: ${error.message}</p>`;
            }
          }

          loadHistory();

          submitButton.addEventListener('click', async () => {
            const problem = problemSelect.value;
            const comment = otherComment.value.trim();
            const preferredVisitTime = preferredDateInput.value;

            if (!problem) {
              alert('Please select an issue type.');
              return;
            }

            if (!preferredVisitTime) {
              alert('Please select your preferred maintenance visit date and time.');
              return;
            }

            const selectedDate = new Date(preferredVisitTime);
            const nowDate = new Date();
            if (selectedDate < nowDate) {
              alert('Preferred visit time cannot be in the past.');
              return;
            }

            if (problem === 'other') {
              if (!comment) {
                alert('Please describe the problem in "Others".');
                return;
              }
              if (!imageUpload.files || imageUpload.files.length < 2) {
                alert('Please upload at least 2 JPEG images.');
                return;
              }

              for (const file of imageUpload.files) {
                if (file.type !== "image/jpeg") {
                  alert('Only JPEG images are allowed.');
                  return;
                }
              }
            }

            statusMessage.style.color = "gray";
            statusMessage.textContent = "Submitting your request...";

            try {
              const tenantEmail = await getCurrentUserEmail();

              let imageUrls = [];
              if (problem === 'other' && imageUpload.files.length > 0) {
                const storage = getStorage(app);
                for (const file of imageUpload.files) {
                  const storageRef = ref(storage, `maintenanceImages/${tenantEmail}/${Date.now()}_${file.name}`);
                  await uploadBytes(storageRef, file);
                  const url = await getDownloadURL(storageRef);
                  imageUrls.push(url);
                }
              }

              await addDoc(collection(db, "maintenanceRequests"), {
                tenantEmail,
                problem,
                comment: problem === 'other' ? comment : '',
                imageUrls: imageUrls,
                status: "Pending",
                responseTime: "Not yet responded",
                preferredVisitTime: new Date(preferredVisitTime),
                timestamp: serverTimestamp()
              });

              statusMessage.style.color = "green";
              statusMessage.textContent = "Maintenance request submitted successfully!";

              problemSelect.value = "";
              otherComment.value = "";
              imageUpload.value = "";
              otherSection.style.display = "none";
              preferredDateInput.value = "";

              loadHistory();

            } catch (error) {
              console.error("Error submitting request: ", error);
              statusMessage.style.color = "red";
              statusMessage.textContent = "Failed to submit request: " + error.message;
            }
          });
          break;

        case 'billing':
          mainContent.innerHTML = `
            <div class="payment-tab">
              <h2>Billing and Payments</h2>
              <p>Pay your monthly dues securely using PayPal.</p>

              <div id="invoiceSection" style="margin-top:20px;">
                <h3>Your Current Invoice</h3>
                <p id="invoiceDetails">Loading your invoice...</p>
                <div id="paypal-button-container" style="margin-top:20px;"></div>
              </div>

              <hr style="margin:25px 0;">

              <h3>Payment History</h3>
              <div id="paymentHistory" style="max-height:300px; overflow-y:auto; font-size:14px;">
                <p>Loading your payment history...</p>
              </div>
            </div>
          `;

          const invoiceDetails = document.getElementById('invoiceDetails');
          const paymentHistory = document.getElementById('paymentHistory');
          const paypalContainer = document.getElementById('paypal-button-container');

          // Load tenant invoice
          async function loadInvoice() {
            const tenantEmail = await getCurrentUserEmail();
            invoiceDetails.innerHTML = `
              <strong>Tenant:</strong> ${tenantEmail}<br>
              <strong>Amount Due:</strong> ₱2,500<br>
              <strong>Due Date:</strong> 25th of this month
            `;
          }

          // Load tenant payment history from Firestore
          async function loadPaymentHistory() {
            paymentHistory.innerHTML = '<p>Loading your payment history...</p>';
            const tenantEmail = await getCurrentUserEmail();

            try {
              const q = query(
                collection(db, "payments"),
                where("tenantEmail", "==", tenantEmail),
                orderBy("timestamp", "desc")
              );
              const snapshot = await getDocs(q);

              if (snapshot.empty) {
                paymentHistory.innerHTML = '<p>No payment records found.</p>';
                return;
              }

              paymentHistory.innerHTML = '';
              snapshot.forEach(doc => {
                const d = doc.data();
                const time = d.timestamp ? d.timestamp.toDate().toLocaleString() : "N/A";
                const div = document.createElement('div');
                div.style.borderBottom = "1px solid #ccc";
                div.style.padding = "8px 0";
                div.innerHTML = `
                  <strong>Invoice ID:</strong> ${d.invoiceId}<br>
                  <strong>Amount:</strong> ₱${d.amount}<br>
                  <strong>Status:</strong> ${d.status}<br>
                  <strong>Date:</strong> ${time}<br>
                  <strong>Payment Method:</strong> ${d.method}
                `;
                paymentHistory.appendChild(div);
              });
            } catch (error) {
              paymentHistory.innerHTML = `<p style="color:red;">Error loading history: ${error.message}</p>`;
            }
          }

          // Initialize PayPal Live Buttons
          async function setupPayPal() {
            const tenantEmail = await getCurrentUserEmail();
            const amount = 2500;
            const invoiceId = "INV-" + Date.now();

            paypal.Buttons({
              style: {
                color: "gold",
                shape: "rect",
                label: "pay",
                height: 40
              },

              // Create order
              createOrder: function(data, actions) {
                return actions.order.create({
                  purchase_units: [{
                    reference_id: invoiceId,
                    description: "Monthly Dues Payment - Solano Hills",
                    amount: {
                      currency_code: "PHP",
                      value: amount.toString()
                    }
                  }]
                });
              },

              // On successful approval
              onApprove: async function(data, actions) {
                const order = await actions.order.capture();
                console.log("Payment successful:", order);

                // Store payment record in Firestore
                await addDoc(collection(db, "payments"), {
                  tenantEmail,
                  invoiceId,
                  amount,
                  method: "PayPal",
                  status: "Paid",
                  transactionId: order.id,
                  payerName: order.payer.name.given_name + " " + order.payer.name.surname,
                  payerEmail: order.payer.email_address,
                  timestamp: serverTimestamp()
                });

                alert("✅ Payment successful! Thank you, " + order.payer.name.given_name + ".");
                loadPaymentHistory();
              },

              // On cancel
              onCancel: function() {
                alert("⚠️ Payment cancelled by user.");
              },

              // On error
              onError: function(err) {
                console.error("PayPal error:", err);
                alert("❌ Payment failed. Please try again later.");
              }
            }).render(paypalContainer);
          }

          loadInvoice();
          loadPaymentHistory();
          setupPayPal();
          break;
  
        case 'feedback':
          loadFeedbackForm();
          break;

        default:
          mainContent.innerHTML = '<p>Section not found.</p>';
      }
    }

    function loadFeedbackForm() {
      mainContent.innerHTML = `
        <div class="feedback-container">
          <h2>Send Feedback to Admin</h2>
          <form id="feedbackForm">
            <label for="question1">1. How satisfied are you with our services?</label>
            <div id="rating" style="font-size: 2rem; margin: 8px 0; user-select:none;">
              <span data-value="1" style="cursor:pointer;">⭐️</span>
              <span data-value="2" style="cursor:pointer;">⭐️</span>
              <span data-value="3" style="cursor:pointer;">⭐️</span>
              <span data-value="4" style="cursor:pointer;">⭐️</span>
              <span data-value="5" style="cursor:pointer;">⭐️</span>
            </div>
            <input type="hidden" id="ratingValue" name="ratingValue" required />

            <label for="question2" style="margin-top:15px;">2. What do you like about our community?</label>
            <textarea id="question2" name="question2" placeholder="Your answer..." style="width:100%; height:80px; padding:8px; border-radius:6px; border:1px solid #ccc;" required></textarea>

            <label for="question3" style="margin-top:15px;">3. What can we improve?</label>
            <textarea id="question3" name="question3" placeholder="Your suggestions..." style="width:100%; height:80px; padding:8px; border-radius:6px; border:1px solid #ccc;" required></textarea>

            <button id="sendFeedbackBtn" type="submit" style="margin-top:15px; padding:10px 20px; background:#8d6c39; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px;">Send Feedback</button>
          </form>
          <p id="statusMessage" style="margin-top:10px; color:green;"></p>
        </div>
      `;

      const form = document.getElementById("feedbackForm");
      const ratingStars = document.querySelectorAll("#rating span");
      const ratingValueInput = document.getElementById("ratingValue");
      const statusMessage = document.getElementById("statusMessage");
      const sendBtn = document.getElementById("sendFeedbackBtn");

      // Rating star click handler
      ratingStars.forEach(star => {
        star.addEventListener("click", () => {
          const val = star.getAttribute("data-value");
          ratingValueInput.value = val;
          // Highlight selected stars
          ratingStars.forEach(s => {
            s.style.opacity = s.getAttribute("data-value") <= val ? "1" : "0.3";
          });
        });
      });

      // Disable send button during cooldown
      function disableButtonForCooldown() {
        sendBtn.disabled = true;
        sendBtn.style.background = "gray";
        sendBtn.style.cursor = "not-allowed";
      }

      function enableButton() {
        sendBtn.disabled = false;
        sendBtn.style.background = "#8d6c39";
        sendBtn.style.cursor = "pointer";
      }

      const cooldownEnd = localStorage.getItem("feedbackCooldownEnd");
      if (cooldownEnd && Date.now() < cooldownEnd) {
        disableButtonForCooldown();
        const remaining = Math.round((cooldownEnd - Date.now()) / 1000);
        statusMessage.textContent = `You can send feedback again in ${remaining}s`;

        const countdown = setInterval(() => {
          const timeLeft = Math.round((cooldownEnd - Date.now()) / 1000);
          if (timeLeft <= 0) {
            clearInterval(countdown);
            enableButton();
            statusMessage.textContent = "";
            localStorage.removeItem("feedbackCooldownEnd");
          } else {
            statusMessage.textContent = `You can send feedback again in ${timeLeft}s`;
          }
        }, 1000);
      }

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          statusMessage.textContent = "Please log in to send feedback.";
          form.style.display = "none";
        } else {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Validate rating selected
            if (!ratingValueInput.value) {
              alert("Please select a rating.");
              return;
            }

            disableButtonForCooldown();
            statusMessage.style.color = "gray";
            statusMessage.textContent = "Sending feedback...";

            try {
              await addDoc(collection(db, "feedback"), {
                tenantEmail: user.email,
                rating: Number(ratingValueInput.value),
                question2: form.question2.value.trim(),
                question3: form.question3.value.trim(),
                timestamp: serverTimestamp()
              });

              statusMessage.style.color = "green";
              statusMessage.textContent = "Feedback sent successfully!";

              // Reset form
              form.reset();
              ratingStars.forEach(s => s.style.opacity = "1");
              ratingValueInput.value = "";

              const cooldownTime = Date.now() + 60000; // 1 minute cooldown
              localStorage.setItem("feedbackCooldownEnd", cooldownTime);

              let countdown = setInterval(() => {
                const timeLeft = Math.round((cooldownTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                  clearInterval(countdown);
                  enableButton();
                  statusMessage.textContent = "";
                  localStorage.removeItem("feedbackCooldownEnd");
                } else {
                  statusMessage.textContent = `You can send feedback again in ${timeLeft}s`;
                }
              }, 1000);

            } catch (error) {
              console.error("Error sending feedback: ", error);
              statusMessage.style.color = "red";
              statusMessage.textContent = "Error sending feedback.";
              enableButton();
            }
          });
        }
      });
    }


    function updateGreeting() {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const greeting = document.getElementById('tenantGreeting1');
          const nameToShow = user.displayName || user.email;
          if (greeting) {
            greeting.textContent = `Hi, ${nameToShow}`;
          }
        }
      });
    }

    function showWelcomeBack() {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const greeting = document.getElementById('tenantGreeting');
          const nameToShow = user.displayName || user.email;
          if (greeting) {
            greeting.textContent = `Welcome back, ${nameToShow}`;
          }
        }
      });
    }

    showWelcomeBack();
  </script>
</body>
</html>
